<div id = "loading" style = "display: none;">
  <p> Your pictures are loading..... </p>
</div>

<div id="mealpanel">
  <% @experience.images.limit(3).each_with_index do |image, index| %>
    <div class="col-md-4" style="padding:0px">
      <%= image_tag image.image_file.url(:medium), id: index %>
    </div>
  <% end %>
</div>

<div class="col-md-4">
  <div class="row center-block" style="padding:0px">
    <% @host = @experience.host %>
    <% if @host.images.present? %>
      <%= image_tag @host.images.first.image_file.url(:medium), class: "img-circle col-md-10 col-md-offset-1" %></br>
    <% else %>
      <%= image_tag "box.jpeg", class: "img-circle col-md-10 col-md-offset-1" %>
    <% end %>
  </div>

  <div class="row">
    <div class="col-md-10 col-md-offset-1">
      <h4><%= @host.username %><p>(<%= @host.email %>)</p></h4>

      <p><strong>Location:</strong>
        <%= @host.suburb %>, <%= @host.state %>, <%= @host.country %></p>

      <p>More events by: <%= link_to @experience.host.username,  "/hosts/" + @experience.host_id.to_s %></p>
    </div>
  </div>

  <div class="row">
    <div class="col-md-10 col-md-offset-1 bg-info" style="border-radius: 10px">
      <br>
      <%= render 'bookings/form' %>
    </div>
  </div>

</div>

<div class="col-md-8" id="mealinfo">
  <div class="row" id="mealframe">
    <%= link_to 'Edit', edit_experience_path(@experience), class: "btn btn-warning btn-sm btn_admins pull-right" if current_host == @experience.host%>

    <%= content_tag 'h1', @experience.title %>

    <%= content_tag 'p', "#{@host.suburb}, #{@host.state}, #{@host.country} (Age #{@host.age})" %>
    <%= content_tag 'p', @host.intro %>
    <%= content_tag 'p', "Speaks: #{@host.languages}" %>

    <label>Neighbourhood:</label>
    <%= content_tag 'p', @host.neighbourhood %>

    <label>Additinal Information:</label>
    <%= content_tag 'p', @host.additional_info %>
  </div>

  <div class="row" style="" id="menuframe">
    <h2>MENU</h2>
    <table class="table" id="menutab">
      <thead>
        <tr>
          <th>MEAL</th>
          <th>ALCOHOL SERVED</th>
          <th>CUISINE</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><%= @experience.meal %></td>
          <td><%= @experience.beverages %></td>
          <td><%= @experience.cuisine %></td>
        </tr>
      </tbody>

       <thead>
        <tr>
          <th>Halal</th>
          <th>Availability</th>
          <th>Group Size</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>
            No
          </td>
          <td><% days = ["Sundays", "Mondays", "Tuesdays", "Wednesdays", "Thursdays", "Fridays", "Saturdays"] %>
      <% avail_days = @experience.available_days.split(//).select {|num| num != "-"}.map { |num| days[num.to_i] } %>
      <%= avail_days.to_sentence %></td>
          <td><%= @experience.max_group_size %> pax</td>
        </tr>
      </tbody>

       <thead>
        <tr>
          <th>Host Style</th>
          <th>Suggested Time</th>
          <th>Price</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>
              <%= @experience.host_style if @experience.host_style %>
          </td>
          <td>
          <%= @experience.time.in_time_zone.strftime('%I:%M %p') %> -
          <%= (@experience.time.in_time_zone +
                @experience.duration.hour).strftime('%I:%M %p') %>
          </td>
          <td><%= @experience.price %> $US</td>
        </tr>
      </tbody>
    </table>

    <div class="col-md-6" style="margin-left:-8px; margin-top:15px">
      <%= content_tag 'p', @experience.description %>
    </div>
  </div>

  <div class="row" id="specframe">
    <h2>SPECIAL EVENTS</h2>
  </div>

  <%if @host.video_url.present?%>
  <div class="row" id="menuframe">
    <h2>VIDEO PRESENTATION</h2>
    <embed width="600" height="315" src=<%= "#{@host.video_url}" %>>
  </div>
  <% end %>

  <div class="row" id="menuframe">
   <h2>MAP</h2>
   <div id="map-canvas" style="float:left; max-width: 600px"></div>
  </div>

                 <!-- Curious map code -->
  <div id="mapLat" style="display: none;">
    <% if @host.latitude -%><%= @host.latitude -%><% else -%>-82.8<% end -%>
  </div>
  <div id="mapLng" style="display: none;">
    <% if @host.longitude %><%= @host.longitude %><% else %>-135<% end %>
  </div>

  <div class="row" id="specframe">
    <h2>MEAL FORMAT</h2>
  </div>

  <div class="row" id="testiframe">
    <h2>REVIEWS</h2>
    <% @testimonials.each do |testimonial| %>
      <%= content_tag 'h5', testimonial.title %>
      <%= simple_format(testimonial.body) %>
    <% end %>
  </div>
</div>

<script>
<% if flash[:notice] %>
$(function(){
    function check_job_status(job_id){
    var request = $.ajax({
      type: "GET",
      url: '/experiences/' + job_id
    });
    request.done(function(response){
      if (response === 'true'){
        location.reload();
      } else {
        setTimeout(function(){ check_job_status(job_id) }, 5000);
      }
    });
  };
   $("#loading").show();
  $("#mealpanel").hide();
  var id = <%= @experience.id %>
  check_job_status(id)
});
<% end %>
</script>
